# Интеграция бота с вашим API

*Обновлено: 2025-02*

---

## Эндпоинты: список и формат запросов/ответов

Бот дергает ваш сервис по этим адресам. Базовый URL задаётся в `BACKEND_API_URL`, значение для заголовка авторизации — в `BACKEND_AUTHORIZATION`. При каждом запросе к вашему API бот передаёт заголовок `Authorization` со значением из `BACKEND_AUTHORIZATION` (его задаёте вы в окружении).

Прочерк (—) в колонке «Запрос»: тела запроса нет, параметры передаются в URL (query или path).

| № | Метод | Путь | Запрос | Ответ |
|---|--------|------|--------|--------|
| 1 | GET | `/api/users/profile?email={email}` | — | `{"email":"string","tariff":"string","expires_at":"YYYY-MM-DD","devices_used":int,"devices_limit":int}` |
| 2 | GET | `/api/tariffs` | — | `[{"id":int,"name":"string","price":number,"period":"month"\|"year","description":"string"}]` |
| 3 | GET | `/api/tariffs/{id}` | — | Один объект как в п.2 или 404 |
| 4 | GET | `/api/vpn/config?email={email}` | — | `{"config_url":"string","qr_code":"string"?}` |
| 5 | POST | `/api/email/send-verification` | `{"email":"string","telegram_id":int}` | `{"success":bool,"message":"string"}` — ваш сервис отправляет письмо с подтверждением; при `success: true` бот показывает message пользователю в Telegram |

**5:** Бот шлёт вам email и telegram_id → вы отправляете пользователю письмо с подтверждением и отвечаете в формате выше. Сейчас письмо шлёт сам бот; после реализации этого эндпоинта бот переключится на вызов вас.

---

## Примеры ответов (как должно выглядеть)

**1. Профиль пользователя** (запрос 1):

```json
{
  "email": "user@example.com",
  "tariff": "Start",
  "expires_at": "2026-12-31",
  "devices_used": 2,
  "devices_limit": 5
}
```

- `expires_at` — дата окончания подписки. Если дата в будущем, подписка считается активной.
- Можно добавлять свои поля — бот их не использует, но и не сломается.

**2. Список тарифов** (запрос 2):

```json
[
  { "id": 1, "name": "Start", "price": 299, "period": "month", "description": "На 1 месяц" },
  { "id": 2, "name": "Годовой", "price": 2990, "period": "year", "description": "На год" }
]
```

- `period` — только `"month"` или `"year"`.
- В боте у кнопок тарифов зашиты номера (id). Эти номера должны совпадать с `id` в вашем ответе.

**3. Конфиг VPN** (запрос 4):

```json
{
  "config_url": "https://ваш-сайт.com/config.ovpn",
  "qr_code": "необязательно, можно не присылать"
}
```

- `config_url` — ссылка, по которой пользователь скачивает конфиг. Бот покажет её в чате.

**4. Отправка письма с подтверждением** (запрос 5).

Бот шлёт на ваш сервер:

```json
{ "email": "user@example.com", "telegram_id": 123456789 }
```

Ваш сервер отправляет письмо и отвечает:

```json
{ "success": true, "message": "Письмо отправлено на user@example.com" }
```

или при ошибке:

```json
{ "success": false, "message": "Не удалось отправить письмо" }
```

Сообщение `message` бот покажет пользователю в Telegram.

---

## Оплаты

Платёж создаётся в боте. Когда пользователь оплатил у вас — ваш сервер должен сообщить об этом боту (так называемый webhook). URL и формат этого запроса договорим отдельно.

---

## Как проверить, что всё работает

1. Сделайте запросы к вашему API (curl, Postman или из кода) по адресам из таблицы эндпоинтов. Проверьте, что ответ совпадает с примерами ниже.
2. Зайдите в бота: откройте «Профиль», «Тарифы», «Установка» (конфиг). Убедитесь, что данные и ссылки те же, что отдаёт ваш API.
3. Если нужно тестировать без вашего сервера — можно поднять тестовый сервер, который отдаёт готовые ответы из примеров выше; в настройках бота указать его адрес.

---

## Если что-то не так — куда смотреть

Логи бота лежат в файле `storage/logs/laravel.log`. В них видно, какой запрос ушёл к вашему серверу и что он ответил.

| Что не работает | Что проверить |
|-----------------|----------------|
| В профиле пусто или не те данные | Ответ вашего сервера на запрос 1: есть ли все поля (tariff, expires_at, devices_used, devices_limit) и правильные ли типы (числа — числа, дата — строка). |
| Тарифы не те или не показываются | Ответ на запрос 2: массив объектов с полями id, name, price, period, description. |
| Не выдаётся конфиг или пишет «нет подписки» | Запрос 1: дата expires_at в будущем? Запрос 4: в ответе есть config_url? |
| Оплата не проходит | В боте есть таблица платежей; плюс логи — пришёл ли от вас webhook об оплате. |
| Ошибка или таймаут при запросе к вам | В логах бота будет строка с именем запроса (UserService, TariffService и т.п.) или «Handler error» — по ней можно найти ответ вашего сервера. |

---

## Чек-лист перед запуском

- [ ] По тестовому email в боте в профиле отображаются тариф, дата окончания, число устройств.
- [ ] В разделе «Тарифы» в боте те же названия и цены, что отдаёт ваш API.
- [ ] При активной подписке в «Установка» показывается ссылка на конфиг и она открывается.
- [ ] Если подключены оплаты — после оплаты статус в боте меняется и доступ открывается.
- [ ] При падении или таймауте вашего API бот не падает, ошибка видна в логах.

---

## Подробно по эндпоинтам (по желанию)

Для тех, кому нужны детали: когда бот дергает каждый запрос, как именно передаются параметры, что делать при ошибках.

**1. Профиль пользователя** — Вызывается при открытии «Мой профиль» (если email привязан) и при проверке подписки перед выдачей конфига. GET, параметр `email` в query. Ответ: JSON с полями `email`, `tariff`, `expires_at` (YYYY-MM-DD), `devices_used`, `devices_limit` (целые). Подписка активна, если `expires_at` в будущем. При ошибке — 404 или 4xx/5xx, бот залогирует.

**2. Список тарифов** — При открытии «Тарифы». GET без параметров. Ответ: массив объектов `{id, name, price, period, description}`. Id в ответе должны совпадать с id кнопок в боте (маппинг при необходимости согласуем).

**3. Тариф по id** — При выборе тарифа (например перед оплатой). GET, id в path. Ответ: один объект как в п.2 или 404.

**4. Конфиг VPN** — При открытии «Установка» (если email привязан и подписка активна). GET, `email` в query. Ответ: `config_url` (обязательно), `qr_code` (необязательно). URL с `example.com` — бот не шлёт файл как документ.

**5. Письмо с подтверждением** — Когда пользователь нажал «Привязать email» и ввёл адрес. POST, тело `{"email", "telegram_id"}`, Content-Type `application/json`. Вы отправляете письмо, отвечаете `{success, message}`; бот показывает message пользователю. Сейчас письмо шлёт бот; после реализации эндпоинта переключится на вас.
